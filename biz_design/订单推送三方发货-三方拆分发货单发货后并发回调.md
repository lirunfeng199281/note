### 情景

订单推送到三方发货 三方拆合生成发货单 发货单发货后回调

我们需要记录三方发货单(主+明细) 和更新订单信息(状态+数量)

### 问题

并发回调上锁问题

### 分析

1. #### 合单情况

   O1 O2推送到三方 三方合成T1发货

   T1并发回调会生成多条T1记录

   给T1上锁解决

2. #### 拆单单情况

   O1推送到三方 三方拆成T1 T2发货

   T1 T2并发回调会导致更新订单发货数量错误

   给O1上锁解决

3. #### 上锁冲突

   一个给O1上锁 一个给T1上锁 冲突

   可以上分别上锁解决


### 设计优化

1. 只更新发货单不更新订单->不太行 订单业务需要查询 已发货 已退货状态 每次都要去相关表查询
2. 上两把锁->麻烦 两次上锁要保持原子性
3. 整个回调一把锁->效率不高 对调用方不友好
4. mq解耦->同一个数据库 有点小题大做 但是我觉得是最好的方式

### 本质问题

1:n或n:1 的结构中 上/下游的变动引起另一边的变动时候 上锁要上1的那边